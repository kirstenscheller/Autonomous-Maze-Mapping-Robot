<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>ECE 3400 Team 2 Website</title>

  <!-- Bootstrap Core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom Fonts -->
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="css/stylish-portfolio.min.css" rel="stylesheet">

</head>

<body id="page-top">

  <!-- Navigation -->
  <a class="menu-toggle rounded" href="#">
    <i class="fas fa-bars"></i>
  </a>
  <nav id="sidebar-wrapper">
    <ul class="sidebar-nav">
      <li class="sidebar-brand">
        <a class="js-scroll-trigger" href="#">Team 2</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger" href="index.html">Home</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger" href="index.html#Team">Team Members</a>
      </li>
 	<li class="sidebar-nav-item">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <span class="nav-label">Labs</span><span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a style="color: #1D809F" href="lab1.html#Lab1">Lab 1</a></li>
                        <li><a style="color: #1D809F" href="lab2.html#Lab2">Lab 2</a></li>
                        <li><a style="color: #1D809F" href="lab3.html#Lab3">Lab 3</a></li>
			<li><a style="color: #1D809F" href="lab4_milestone4.html#Milestone4">Lab 4</a></li>
                    </ul>
                </li>
	<li class="sidebar-nav-item">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <span class="nav-label">Milestones</span><span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a style="color: #1D809F" href="milestones.html#Milestone1">Milestone 1</a></li>
                        <li><a style="color: #1D809F" href="milestone2.html#Milestone2">Milestone 2</a></li>
                        <li><a style="color: #1D809F" href="milestone3.html#Milestone3">Milestone 3</a></li>
                        <li><a style="color: #1D809F" href="lab4_milestone4.html#Milestone4">Milestone 4</a></li>
                    </ul>
                </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger" href="TEAM CONTRACT.pdf">Team Contract</a>
      </li>
    </ul>
  </nav>

  <!-- Header -->
  <header class="masthead d-flex">
    <div class="container text-center my-auto">
      <h1 class=class="mb-1" style="color: white; text-shadow: 2px 2px 5px black">Labs</h1>
      <h3 class=class="mb-1" style="color: white; text-shadow: 2px 2px 5px black">
        <em> What We Have Worked on in Labs </em>
      </h3>
      <a class="btn btn-primary btn-xl js-scroll-trigger" href="#Labs">Start</a>
    </div>
    <div class="overlay"></div>
  </header>

  <!-- Labs -->
  <section class="content-section bg-primary text-white text-center" id="Labs">
    <div class="container">
      <div class="content-section-heading">
        <h3 class="text-secondary mb-0">Labs</h3>
        <h2 class="mb-5">What We Worked On</h2>
      </div>
      <div class="row">
        <div class="col-lg-3 col-md-6 mb-5 mb-lg-0">
          <span class="service-icon rounded-circle mx-auto mb-3">
   	<a href="lab1.html#Lab1"><i class="icon-screen-smartphone"></i></a>
          </span>
          <h4><a href="lab1.html#Lab1" style="color: #FFFFFF">
	<strong>Lab1</strong>
		  </h4></a>

          <p class="text-faded mb-0">Microcontrollers</p>

        </div>
        <div class="col-lg-3 col-md-6 mb-5 mb-lg-0">
          <span class="service-icon rounded-circle mx-auto mb-3">
          <a href="lab2.html#Lab2"><i class="icon-pencil"></i></a>
          </span>
          <h4><a href="lab2.html#Lab2" style="color: #FFFFFF">
            <strong  >Lab2</strong>
          </h4></a>
          <p class="text-faded mb-0"> FFT and Schmitt Trigger</p>
        </div>
        <div class="col-lg-3 col-md-6 mb-5 mb-md-0">
          <span class="service-icon rounded-circle mx-auto mb-3">
          <a href="lab3.html#Lab3"><i class="icon-like"></i></a>
          </span>
          <h4><a href="lab3.html#Lab3" style="color: #FFFFFF">
		  <strong>Lab 3</strong>
          </h4></a>
          <p class="text-faded mb-0">FPGA Video Controller</p>
        </div>
        <div class="col-lg-3 col-md-6">
          <span class="service-icon rounded-circle mx-auto mb-3">
            <a href="lab4_milestone4.html#Milestone4"><i class="icon-mustache"></i></a>
          </span>
          <h4><a href="lab4_milestone4.html#Milestone4" style="color: #FFFFFF">
		  <strong>Lab 4</strong>
          </h4></a>
          <p class="text-faded mb-0">Radio Communication and Full Robotic Integration</p>
        </div>
      </div>

    </div>
  </section>
	
	
 <!--Lab2-->
  <section class="content-section bg-light" id="Lab2">
    <div class="container">
      <div class="row text-center">
        <div class="col-lg-10 mx-auto">
          <h2>Lab 2 FFT and Schmitt Trigger Circuit</h2>
          <div class="row">
          <div class="col-lg-3"> 
   
           </div>
          </div>
         
        </div>
      </div>

  <br/>
      <br/>
      
	    <div class="row">
        <div class="col-lg-10 mx-auto">
		<p style = "text-indent: 50px;">In this lab, we built a microphone amplifier and filter circuits to detect the whistle blow signifying the beginning of the robot mapping competition, and the frequency of the tone is 950 Hz. We also built the Schmitt trigger circuit to free up the analog pins. </p>
		<ul>Materials Used:
			<li>1 Arduino Uno</li>
			<li>1 USB A/B cable</li>
			<li>1 Microphone</li>
			<li>1 LM358 Op-Amp</li>
			<li>Various resistors</li>
			<li>Various capacitors</li>
			<li>1 Solderless breadboard</li>
			
		</ul>
		<h3>Part I: FFT</h3>
		<p>1. We started the lab by testing the microphone. We built the simple microphone circuit in the lab handout and checked if the microphone was picking up any sound. A picture of the microphone circuit is shown below. (The resistor value we used is 330 ohms and the capacitor value we used is 6.8uF.) We found that the microphone was picking up sound, but the amplitude was very small. It was close to 5mV. Therefore, our next step was to build an amplifier circuit to amplify the signal. </p>
		<img src="Pictures/microphone circuit.jpg"/>
</br>
 </br>
	<p>2. The picture below shows the amplifier circuit that we built in lab. It is an inverting amplifier. The gain for this amplifier circuit is R2/R3, which is 131. Resistor R1 and R5 together act as a voltage divider and set a DC offset of 2.5V. The Arduino analogRead function can only measures signals from 0 to 5V. So, we created this DC offset to make sure that the analogRead function is reading a proper input. </p>
	    <img width = "800" height = "518" src="Pictures/amplifier.jpg"/>
	    </br>
	  </br>
	    <p>3. We tested the amplifier circuit and it worked. It outputs a sine wave even though it is not a perfect one. Also, limited by the quality of the microphone, we needed to hold the signals very close to the microphone in order for the amplifier circuit to function properly. We used the oscilloscope to display the output waveform of the amplifier circuit. We knew that the input signal to the amplifier circuit from the microphone is about 5mV, and the gain is 131. Therefore, we should expect to see about 655mV of output. The picture below shows the output waveform of our amplifier circuit, which was what we expected it to be.  </p>
	    <img src="Pictures/oscilloscope waveform.jpg"/>
	    </br>
	  </br>
	    <p>4. We also used the FFT function on the oscilloscope to test our amplifier circuit. And the video below shows our amplifier amplifying signals of different frequencies. One can see that there is an obvious peak correponding to the frequency coming out from the frequency generator. </P>
	    <video width ="360" height ="640" controls>

			    <source src = "Videos/FFT at different frequencies.mp4" type = "video/mp4"

				    Your Browser does not support the video tag.
				    </video> 
		     </div>
          </div>
	    <br/>
	    <br/>
	  <div class="row">
        <div class="col-lg-10 mx-auto">
	   <p>5. After we got the amplifier to work, we then moved on to make a filter circuit. Originally, we wanted to build a bandpass filter. The break frequencies for high pass and low pass filter are then same, which is 1/(2*pi*R*C). We wanted the pass band to be from 884Hz and 1061Hz. Therefore, we chose the values of capacitors and resistors accordingly. (For the high pass filter, the R is 1.8K, and the C is 0.1uF; for the low pass filter, the R is 1.5K, and the C is 0.1uF.)</p>
	    <p>6. However, the bandpass circuit didn’t work. We built a high pass filter to the input of the amplifier and a low pass filter to the output of the amplifier. The high pass filter somehow killed the signal from the microphone. We were not exactly sure why this happened. At the end, we decided to simply make a high pass filter at the output of the amplifier to filter out the low frequency human voice and background noise. The schematic below shows our amplifier circuit with a high pass filter.</p>
	    <img width = "800" height = "400" src="Pictures/amplifier and filter.jpg"/>
	    </br>
	  </br>
	    <p>7. We then tested the circuit using the oscilloscope. Looking at the singal before and after the high pass filter, we could clearly see that the low frequency signals are getting filtered because the amplitudes of the low frequency signals got reduced significantly. The video below shows the output signals displayed on the oscilloscope before and after the installation of the filter.</p>
	     <video width ="360" height ="640" controls>
			    <source src = "Videos/high pass filter.mp4" type = "video/mp4"
				    Your Browser does not support the video tag.
				    </video>	    
           </div>
          </div>
	    <br/>
	    <br/>
        
	    <!--part2-->    
	    
    <div class="row">
        <div class="col-lg-10 mx-auto">
	<p>8. As a way to debug our filter circuit, we tested the low pass and high pass filter separately using the oscilloscope. We found out that the first order passive filters didn’t work quite well. The signals didn’t drop to zero immediately after the break frequency. The chart below shows the lab data for both the high pass and low pass filter. After we consulted with Professor Shoaran on Friday meeting, we realized that our circuit still has gains after the break frequency. The only way to get a sharper roll off at break frequency is to make a second order filter. The data we collected on the performance of the low pass and high pass filter are shown below. We can see that the amplitudes drop to half of its original at 600Hz for high pass filter and at 1600Hz for the low pass filter. So high pass and low pass filter works, but they are not very good filter.</P>
	    	    <img width = "600" height = "280" src="Pictures/high and low pass data.png"/>
	    </br>
	  </br>
	    <p>9. After we finished building the amplifier circuit with the high pass filter, we were ready to test the FFT using the Arduino. We started by using the fft_adc_serial example code provided by the FFT library. Then we ran the program and plotted the data using Excel. However, when we plotted out the output, we found out that the 950Hz frequency fell in the 6th bin, which was not what we expected to be. Because the FFT is running at a 9600Hz, and the sample size is 256. This means that each bin has a width of 9600/256=37.5Hz. Therefore, the 950Hz signal should be in the 25th bin. After talking to people from other groups, we found out that our FFT was sampling at a higher frequency than 9600Hz, which was the reason why the 950Hz was in the 6th bin instead of the 25th bin. After changing the prescaler of the ADCSRA to 128 in the code, we got correct FFT analysis from the Arduino.The chart below shows the FFT analysis of three different frequencies using the data from the Arduino serial port.</P>
	  <img src="Pictures/FFT Analysis of Different Frequencies.png"/>
	    </br>
	  </br>
	<p>10. Finally, we modified the code in fft_adc_serial so that it will print out “950  detected” when the 950 frequency is heard and print out “not detected” otherwise. The video below shows the 950Hz signal detection. And our code for the FFT analysis is also shown here. </P>

   <!-- Trigger the modal with a button -->
<button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal2">FFT Code</button>

<!-- Modal -->
<div id="myModal2" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">FFT Code</h4>
      </div>
      <div class="modal-body">
        	<code > 
		<pre style="color: #b32789">
#define LOG_OUT 1 // use the log output function
#define FFT_N 256 // set to 256 point fft

#include &lt;FFT.h&gt; // include the library

void setup() {
  Serial.begin(9600); // use the serial port
  TIMSK0 = 0; // turn off timer0 for lower jitter
  ADCSRA = 0xe7; // we change the presacler here to 128 by setting the ADCSRA to 0xe7
  ADMUX = 0x44; // use adc4
  DIDR0 = 0x04; // turn off the digital input for adc4
}

void loop() {
  while(1) { // reduces jitter
    cli();  // UDRE interrupt slows this way down on arduino1.0
    for (int i = 0 ; i < 512 ; i += 2) { // save 256 samples
      while(!(ADCSRA & 0x10)); // wait for adc to be ready
      ADCSRA = 0xf7; // restart adc
      byte m = ADCL; // fetch adc data
      byte j = ADCH;
      int k = (j << 8) | m; // form into an int
      k -= 0x0200; // form into a signed int
      k <<= 6; // form into a 16b signed int
      fft_input[i] = k; // put real data into even bins
      fft_input[i+1] = 0; // set odd bins to 0
    }
    fft_window(); // window the data for better frequency response
    fft_reorder(); // reorder the data before doing the fft
    fft_run(); // process the data in the fft
    fft_mag_log(); // take the output of the fft
    sei(); 
    Serial.println("start");
    for (byte i = 0 ; i < FFT_N/2 ; i++) { 
      Serial.println(fft_log_out[i]); // send out the data
      if(fft_log_out[25] > 100){
        Serial.println("950 detected");
      }else{
        Serial.println("not detected");
      }
      }
    }
  }




		</pre>
		</code>	
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
		     
            </div>
	    </div>
	
	  <br/>
      <br/>
<div class="row">
        <div class="col-lg-10 mx-auto">
<video width ="360" height ="640" controls>

			    <source src = "Videos/950 Hz signal.mp4" type = "video/mp4"

				    Your Browser does not support the video tag.
				    </video> 
           </div>
	    </div>
	
	  <br/>
      <br/>

	
	    <!--part3-->    
	    
    <div class="row">
        <div class="col-lg-10 mx-auto">
		<h3>Part II: Additional Circuit---Schmitt Trigger</h3>
		<p>1. For our additional circuit, we made a Schmitt trigger with positive feedback. We chose to do this in order to free up 2 analog pins at the expense of 2 digital pins, since there are far more digital pins than analog pins. The Schmitt Trigger allows us to read the value of the line sensors as a digital value rather than an analog value. The output of the circuit is a ‘0’ if the line sensor is above black and a ‘1’ if it is above a white line.  </p>
		<p>2. The main components of the circuit are the op-amp, the line sensor input, which goes into the inverting input, and the 3 resistors. Vref was just 5V and Vout was the output (0 or 1). We used a multimeter to test the voltages outputted by the line sensors when over black or white and then used those values as the lower (~3V) and upper (~4V) thresholds. If the voltage outputted by the line sensor is below 3V, the value of Vout changes, and when the voltage is greater than 4V, Vout with change back. The upper/lower thresholds are there to make the transition smoother so that spikes in voltage do not affect the transitions as much. In order to achieve these thresholds, we calculated the resistor values. We discovered that the resistor going into the inverting input should be approximately 3 times the value of the other 2 resistors, which should be the same resistance. We chose to use 10K and 33K Ohm resistors, which have the same effectiveness in classifying whether or not the robot is over a white line. The circuit diagram is shown below. </p>
		<img src="Pictures/schmitt trigger circuit.png"/>
	    </br>
	  </br>


   <!-- Trigger the modal with a button -->
<button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Schmitt Triger Code</button>

<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Schmitt Trigger Code</h4>
      </div>
      <div class="modal-body">
        	<code > 
		<pre style="color: #b32789">
#include &lt;Servo.h&gt;

int llinesen = 5; //line sensor on the left
int rlinesen = 4; //line sensor on the right
int rWheelPin = 10; //right wheel
int lWheelPin = 9; //left wheel

int counter = 0;  //counter to keep track of where the robot is in figure 8
int threshold = 750;
Servo rWheel;
Servo lWheel;


void setup() {
  Serial.begin(9600);
  pinMode(rWheelPin, OUTPUT);
  pinMode(lWheelPin, OUTPUT);
  pinMode(rlinesen, INPUT);
  rWheel.attach(rWheelPin);
  lWheel.attach(lWheelPin);
}

void loop() {

 //Uncomment the following line for testing line sensor values
  //test();
  
  rWheel.write(90);
  lWheel.write(90);
  
  if (isLeftWhite() && isRightWhite()){
    Serial.println(digitalRead(rlinesen));
    Serial.println(digitalRead(llinesen));

    rWheel.write(90);
    lWheel.write(90);
    delay(300);
    Serial.println(counter);
  
    switch (counter) {
      case 0:
      case 5:
        if(isLeftWhite() && isRightWhite()){
          turnRight();
          moveForward();
          moveForward();
        } else {
          counter--;
        }
        break;
      case 6:
        if(isLeftWhite() && isRightWhite()){
          turnRight();
          moveForward();
          moveForward();
        } else {
          counter--;
        }
        break;     
      case 1 ... 4:
        if(isLeftWhite() && isRightWhite()){
          turnLeft();
          moveForward();
        } else {
          counter --;
        }
        break;
      default: 
        break;
    } 
    counter ++;
  }
  
  lineFollow();
}

void moveForward() {
  Serial.println("Moving Forward!");
  rWheel.write(87);      
  lWheel.write(93);
  delay(50);
}

void turnRight() {
  Serial.println("Turning Right!");
  //move forward a little bit before turning to prevent overturn
  moveForward();
  moveForward();
  //stop and then turn
  rWheel.write(90);
  lWheel.write(90);
  delay(200);
  rWheel.write(95);
  lWheel.write(180);
  delay(675);
}

void turnLeft() {
  Serial.println("Turning Left!");
  moveForward();
  moveForward();
  rWheel.write(90);
  lWheel.write(90);
  delay(200);

  rWheel.write(0);
  lWheel.write(180);
  delay(675);
}

/*this function is for the robot to readjust itself <br>
if it goes off the white line.*/
void lineFollow() {
  if (isLeftWhite() && (!isRightWhite())){
    Serial.println("Correct line left");
    rWheel.write(85);
    lWheel.write(85);
    delay(100);
  }
  else if ((!isLeftWhite()) && isRightWhite()){
    Serial.println("Correct line right");
    rWheel.write(95);
    lWheel.write(95);
    delay(100);
  } 
  else {    
    moveForward();   
  }
  
}

bool isLeftWhite() {
  return digitalRead(llinesen) == 1;
}

bool isRightWhite() {
  return digitalRead(rlinesen) == 1;
}


void test() {
  while(true){
    rWheel.write(90);
    lWheel.write(90);
    Serial.print("left  Sensor: ");
    Serial.println(digitalRead(llinesen));
    Serial.print("Right Sensor: ");
    Serial.println(digitalRead(rlinesen));
  }
}



			</pre>
		</code>	
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
           </div>
          </div>
	    <br/>
	    <br/>
<div class="row">
        <div class="col-lg-10 mx-auto">
		<p>3. This video below shows our working Schmitt trigger circuit.It will output a "1" when the line sensors detect the white line, and it will output a "0" when the line sensors detect the black area. 
<video width ="640" height ="360" controls>

			    <source src = "Videos/Schmitt Trigger working.mp4" type = "video/mp4"

				    Your Browser does not support the video tag.
				    </video> 
           </div>
	    </div>
	
	  <br/>
      <br/>
	
	    
    </div>
  </section>

  <!-- Callout -->
  <section class="callout">
    <div class="container text-center">
      <h2 class="mx-auto mb-5">Welcome to
        <em>our</em>
        website!</h2>
      <a class="btn btn-primary btn-xl" href="#">Github Link</a>
    </div>
  </section>



  <!-- Call to Action -->
  <section class="content-section bg-primary text-white">
    <div class="container text-center">
      <h2 class="mb-4">The buttons below are impossible to resist...</h2>
      <a href="#" class="btn btn-xl btn-light mr-4">Click Me!</a>
      <a href="#" class="btn btn-xl btn-dark">Look at Me!</a>
    </div>
  </section>

 


  <!-- Footer -->
  <footer class="footer text-center">
    <div class="container">
      <ul class="list-inline mb-5">
        <li class="list-inline-item">
          <a class="social-link rounded-circle text-white mr-3" href="#">
            <i class="icon-social-facebook"></i>
          </a>
        </li>
        <li class="list-inline-item">
          <a class="social-link rounded-circle text-white mr-3" href="#">
            <i class="icon-social-twitter"></i>
          </a>
        </li>
        <li class="list-inline-item">
          <a class="social-link rounded-circle text-white" href="#">
            <i class="icon-social-github"></i>
          </a>
        </li>
      </ul>
      <p class="text-muted small mb-0">Copyright &copy; Start Bootstrap: Stylish Portfolio Theme</p>
    </div>
  </footer>

  <!-- Scroll to Top Button-->
  <a class="scroll-to-top rounded js-scroll-trigger" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Plugin JavaScript -->
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

  <!-- Custom scripts for this template -->
  <script src="js/stylish-portfolio.min.js"></script>

</body>

</html>

